name: Deploy to Azure Web App

on:
  push:
    branches:
      - main

jobs:
  infra-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ "${{ secrets.AZURE_CREDENTIALS }}" }}

      # 1. Bicep으로 인프라 프로비저닝 (IaC)
      - name: Deploy Azure Resources
        id: deploy_infra
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ "${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}" }}
          resourceGroupName: ${{ "${{ secrets.AZURE_RESOURCE_GROUP }}" }}
          template: ./infra/main.bicep
          parameters: >
            webAppName=${{ values.name }}
            linuxFxVersion=${{ values.runtime }}
            sku=${{ values.sku }}

      # 2. 애플리케이션 빌드 및 배포
      # app-name은 Bicep output(webAppName)에서 가져옴 — uniqueString 접미사 포함된 실제 이름
      - name: Deploy Application Code
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ "${{ steps.deploy_infra.outputs.webAppName }}" }}
          package: .